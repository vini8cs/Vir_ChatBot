services:
  web:
    build: .
    image: vir-chatbot:latest
    ports:
      - "${WEB_PORT:-8000}:${WEB_PORT:-8000}"
    env_file:
      - .env
    volumes:
      - ${VECTORSTORE_PATH}:/app/vectorstore/
      - ${PDF_FOLDER}:/app/pdfs/
      - ${GCP_CREDENTIALS}:/app/gcp_credentials.json
      - ${CACHE_FOLDER_PATH}:/app/cache/
      - ${SQLITE_MEMORY_DATABASE}:/app/db_data/
      - /tmp/temp_uploads:/tmp/temp_uploads
    environment:
      - PYTHONUNBUFFERED=1
      - VECTORSTORE_PATH=/app/vectorstore/
      - PDF_FOLDER=/app/pdfs/
      - GCP_CREDENTIALS=/app/gcp_credentials.json
      - CACHE_FOLDER_PATH=/app/cache/
      - SQLITE_MEMORY_DATABASE=/app/db_data/memory.sqlite
      - WEB_PORT=${WEB_PORT:-8000}
    command: uvicorn backend.api:app --host 0.0.0.0 --port ${WEB_PORT:-8000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${WEB_PORT:-8000}/health"]
      interval: 60s
      timeout: 5s
      retries: 5
    depends_on:
      - redis
      - worker

  worker:
    build: .
    image: vir-chatbot:latest
    command: celery -A agents.vir_chatbot.tasks worker -l info
    depends_on:
      - redis
    env_file:
      - .env
    volumes:
      - ${VECTORSTORE_PATH}:/app/vectorstore/
      - ${PDF_FOLDER}:/app/pdfs/
      - ${GCP_CREDENTIALS}:/app/gcp_credentials.json
      - ${CACHE_FOLDER_PATH}:/app/cache/
      - ${SQLITE_MEMORY_DATABASE}:/app/db_data/
      - /tmp/temp_uploads:/tmp/temp_uploads
    environment:
      - PYTHONUNBUFFERED=1
      - VECTORSTORE_PATH=/app/vectorstore/
      - PDF_FOLDER=/app/pdfs/
      - GCP_CREDENTIALS=/app/gcp_credentials.json
      - CACHE_FOLDER_PATH=/app/cache/
      - SQLITE_MEMORY_DATABASE=/app/db_data/memory.sqlite
      - REDIS_PORT=${REDIS_PORT:-6379}
  redis:
    image: redis:7
    ports:
      - "${REDIS_PORT:-6379}:${REDIS_PORT:-6379}"
    command: redis-server --port ${REDIS_PORT:-6379}
  
  redis-commander:
    profiles:
      - dev
    image: rediscommander/redis-commander:snyk-fix-08c85f17c94a7f00df6fb21e8ea1d10d
    environment:
      - REDIS_HOSTS=local:redis:${REDIS_PORT:-6379}
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:${REDIS_COMMANDER_PORT:-8081}"
    command: --port ${REDIS_COMMANDER_PORT:-8081}

  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    ports:
      - "${STREAMLIT_PORT:-8501}:${STREAMLIT_PORT:-8501}"
    env_file:
      - .env
    volumes:
      - ${VECTORSTORE_PATH}:/app/vectorstore/
      - ${PDF_FOLDER}:/app/pdfs/
      - ${GCP_CREDENTIALS}:/app/gcp_credentials.json
      - ${CACHE_FOLDER_PATH}:/app/cache/
      - ${SQLITE_MEMORY_DATABASE}:/app/db_data/
    environment:
      - PYTHONUNBUFFERED=1
      - VECTORSTORE_PATH=/app/vectorstore/
      - PDF_FOLDER=/app/pdfs/
      - GCP_CREDENTIALS=/app/gcp_credentials.json
      - CACHE_FOLDER_PATH=/app/cache/
      - SQLITE_MEMORY_DATABASE=/app/db_data/memory.sqlite
      - API_BASE_URL=http://web:${WEB_PORT:-8000}
      - STREAMLIT_PORT=${STREAMLIT_PORT:-8501}
    command: streamlit run app.py --server.port=${STREAMLIT_PORT:-8501} --server.address=0.0.0.0
    depends_on:
      web:
        condition: service_healthy
